0327


- modify.jsp 
form태그 수정

- productController
@PostMapping("modify/{pno}")
	public String modifyPOST(
			@PathVariable("pno")Integer pno,
			ProductDTO productDTO) {
		
		log.info("pno: " + pno);
		
		//기존에 파일들을 알아두어야 함 - 나중에 필요없는 파일들을 삭제 
		List<String> oldFiles = service.get(pno).getFileNames();
		
		//double checking
		productDTO.setPno(pno);
		
		MultipartFile[] files =  productDTO.getFiles();
		
		//업로드된 파일의 이름들
		List<String> fileNames = new ArrayList<>();
		
		for(MultipartFile file:files) {
			
			log.info("-------------");
			String contentType = file.getContentType();
			
			if(contentType.startsWith("image") == false) {
				continue;
			}
			
			String uuid = UUID.randomUUID().toString();
			
			String saveFileName = uuid +"_"+file.getOriginalFilename();
			
			String thumbFileName = "s_"+ saveFileName;
			
			File target = new File("C:\\upload\\" + saveFileName );
			
			File thumbFile = new File("C:\\upload\\" + thumbFileName);
			
			try {
				file.transferTo(target);
				
				Thumbnails.of(target)
		        .size(200,200)
		        .toFile(thumbFile);
				
				fileNames.add(saveFileName);
				
			} catch (Exception e) {
				e.printStackTrace();
			}
		}//end for
		
		//최종 결과물 
		productDTO.getFileNames().addAll(fileNames);
		
		log.info("--------------------");
		log.info(productDTO);
		log.info("--------------------");
		
		//서비스를 통해서 DB에 반영 
		
		
		//기존에 존재했지만 화면에서 삭제된 파일들은 지워야 함 
		List<String> recent =  productDTO.getFileNames();
		
		List<String> filteredList = oldFiles.stream()
			    .filter(oldFile -> !recent.contains(oldFile)) // recent에 없는 항목 필터링
			    .collect(Collectors.toList());
		
		log.info("--------------------");
		log.info(filteredList);
		log.info("--------------------");
		
		return null;
	}


- ProductMapper.java
int deleteFiles(Integer pno);


- ProductMapper.xml
<delete id="deleteFiles">
delete from tbl_product_img where pno = #{pno}
</delete>

- ProductMapper.java
int update(ProductDTO productDTO);

- ProductMapper.xml
<update id="update">
update tbl_product set pname = #{pname}, pdesc = #{pdesc}, price = #{price}, updateDate = now()
where pno = #{pno}
</update>

- ProductService.java
void modify(ProductDTO productDTO);

- ProductServiceImpl.java
Integer pno = productDTO.getPno();
//모든 파일들 삭제
mapper.deleteFiles(productDTO.getPno());

mapper,update(productDTO);

mapper.insertImgs(productDTO.getFileNames(), pno);

- ProductController
//서비스를 통해서 DB에 반영 
		
		service.modify(productDTO);
-------------------------------------
//파일 지우기
filteredList.forEach(targetFile -> {
	new File("C:\\upload\\"+ targetFile).delete();
	new File("C:\\upload\\s_"+ targetFile).delete(); //썸네일도 같이 삭제해야 함
});

-------------------------------------

@PostMapping("modify/{pno}")
	public String modifyPOST(
			@PathVariable("pno")Integer pno,
			PageRequestDTO requestDTO,
			ProductDTO productDTO) {

//수정 누르면 read로 이동
return "redirect:/product/read/"+pno+ requestDTO.getPageLink();

- pom.xml
<!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-core -->
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-core</artifactId>
    <version>6.4.4</version>
</dependency>

<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-web</artifactId>
    <version>6.4.4</version>
</dependency>

<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-config</artifactId>
    <version>6.4.4</version>
</dependency>

<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-taglibs</artifactId>
    <version>6.4.4</version>
</dependency>


-root-context.xml
<context~aop> 삭제

- WEB-INF / spring / security-context.xml 생성

<beans:beans xmlns="http://www.springframework.org/schema/security"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xsi:schemaLocation="
                 http://www.springframework.org/schema/security 
                 https://www.springframework.org/schema/security/spring-security.xsd
                 http://www.springframework.org/schema/beans 
                 https://www.springframework.org/schema/beans/spring-beans.xsd">

</beans:beans>

- web.xml
/WEB-INF/spring/security-context.xml 추가

~~~~~

	<filter>
		<filter-name>springSecurityFilterChain</filter-name>
		<filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
	</filter>
	<filter-mapping>
		<filter-name>springSecurityFilterChain</filter-name>
		<url-pattern>/*</url-pattern>
	</filter-mapping>


- log4j2
<!-- Logger 설정 -->
    <Loggers>
        <Logger name="com.zaxxer" level="DEBUG" additivity="false">
            <AppenderRef ref="console"/>
        </Logger>
        <Logger name="org.springframework" level="INFO" additivity="false">
            <AppenderRef ref="console"/>
        </Logger>
        <Logger name="org.springframework.security.web" level="TRACE" additivity="false">
           <AppenderRef ref="console"/>
       </Logger>
       <Logger name="org.zerock" level="INFO" additivity="false">
           <AppenderRef ref="console"/>
       </Logger>

        <Root level="INFO">
            <AppenderRef ref="console"/>
        </Root>
    </Loggers>

- security-context.xml
<http>
	<form-login/>
</http>

<authentication-manager>
        <authentication-provider>
            <user-service>
                <user name="admin" password="{noop}admin" authorities="ROLE_ADMIN"/>
                <user name="user" password="{noop}user" authorities="ROLE_USER"/>
            </user-service>
        </authentication-provider>
    </authentication-manager>


- servlet-context.xml

<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       https://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/mvc
       https://www.springframework.org/schema/mvc/spring-mvc.xsd
       http://www.springframework.org/schema/security
       https://www.springframework.org/schema/security/spring-security.xsd">

~~~~~~~~~~~~~~~~

<security:global-method-security pre-post-annotations="enabled"/>


- org.zerock / config / MvcConfig.java 생성
package org.zerock.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.handler.HandlerMappingIntrospector;

@Configuration
@EnableWebMvc
public class MvcConfig {
	
	@Bean
    public HandlerMappingIntrospector mvcHandlerMappingIntrospector() {
        return new HandlerMappingIntrospector();
    }

}

- security_context
	<context:component-scan base-package="org.zerock.config"></context:component-scan>
	
	<http>
		<form-login/>
		<intercept-url pattern="/resources/**" access="permitAll"/>
		<intercept-url pattern="/files/**" access="permitAll"/>
		<intercept-url pattern="/board/**" access="permitAll"/>
		<intercept-url pattern="/replies/**" access="permitAll"/>
		<intercept-url pattern="/product/**" access="permitAll"/>
		
		<csrf disabled="true"/>

	</http>
	
- security_context
	<http>
		<form-login/>
		
		<intercept-url pattern="/resources/**" access="permitAll"/>
		<intercept-url pattern="/files/**" access="permitAll"/>
		<intercept-url pattern="/board/**" access="permitAll"/>
		<intercept-url pattern="/replies/**" access="permitAll"/>
		<intercept-url pattern="/product/**" access="permitAll"/>
		
		<csrf disabled="true"/>
		
	</http> 삭제

- org/zerock / config / CustomSecurityConfig 생성
@Configuration
@EnableWebSecurity
@Log4j2
~~~~~~~~~~~~~~~
@Bean
public SecurityFilterChain securityFilterChain( HttpSecurity http ) throws Exception {

	log.info("----------------");
	log.info("--------securityFilterChain--------");
	log.info("----------------");
	
	http.formLogin(config -> { });

	return http.build();
}

- BoardController
@PreAuthorize("hasRole('ADMIN')")

- CustomSecurityConfig 
	//쿠키 자동 로그인
	http.rememberMe(config -> {
		config.todenValiditySeconds(604800); //일주일
	});

	http.csrf(config -> {
		config.disable();
	});

- security.service / CustomUserDetailsService 생성
@Service
@Log4j2
public class CustomUserDetailsService implements UserDetailsService{

	@Override
	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
		
		log.info("========loadUserbyUsername=========" + username);
		
		return null;
	}
	
}

- BoardController
@PreAuthorize("hasRole('USER')")

======================================

- security-context
<beans:bean name="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"></beans:bean>
	
- Custom
@RequiredArhsConstructor

~~~~~~~~~~

private final PasswordEncoder passwordEncoder;
~~~~~~~~~~~~~

log.info("=======passwordEncoder======" + passwordEncoder);
log.info("=======1111======" + passwordEncoder.encode("1111"));








