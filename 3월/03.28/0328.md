0328


사용자 정보를 DB에서 처리

Remember Me - 서버 재시작해도 DB에서 정보를 보관하도록 변경

커스텀 로그인 페이지

로그인 성공 / 실패

Access Denied 핸들러 (처리)

과거 Java - 인터페이스 - 추상 메서드, 상수 -> 중간에 추상 클래스 만들어줌

최근 JAva - 인터페이스 - 추상 메서드, 상수, default 메서드

로그아웃
: CSRF를 사용하지 않는다면  GET 바식으로도 로그아웃 가능 /logout
로그아웃하면 remember me 쿠키도 같이 삭제 persistent_logins 테이블에서도 삭제

커스텀 로그인 페이지

파라미터는 username, password라는 name 속성 이용

로그인 관련 커스터마이징 - AuthenticationSuccessHandler / AuthenticationFailerHandler

-------------------------------------------------------

- DB : tbl_member 테이블 생성

- org.zerock.member / dto / MemberDTO.java 생성
package org.zerock.member.dto;

import java.time.LocalDateTime;
import java.util.List;

import lombok.Data;

@Data
public class MemberDTO {

	private String mid;
	private String mpw;
	private String mname;
	private String email;
	
	private LocalDateTime regDate;
	private LocalDateTime modDate;

	private List<String> roleNames;
}





- MemberMapper.java 생성
	int insert(MemberDTO memberDTO);

- mybatis-config.xml
	<package name="org.zerock.member"/>

- MemberMapper.xml 생성
	<?xml version="1.0" encoding="UTF-8"?>
	<!DOCTYPE mapper
	        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<mapper namespace="org.zerock.board.mapper.MemberMapper">
	</mapper>

- src/test/java/org/zerock/member.mapper/MemberMapperTests 생성
	@ExtendWith(SpringExtension.class)
	@Log4j2
	@WebAppConfiguration
	@ContextConfiguration(
			{"file:src/main/webapp/WEB-INF/spring/root-context.xml",
			"file:src/main/webapp/WEB-INF/spring/servlet-context.xml",
			"file:src/main/webapp/WEB-INF/spring/security-context.xml"}
			)
	public class MEmberMapperTests {
		
	@Autowired(required = false)
	private PasswordEncoder passwordEncoder;

	@Test
	public void test1() {
		log.info(passwordEncoder);
	
		for(int i = 0; i < 10. i++) {
		String enStr = passwordEncoder.encode("1111")
		log.info(enStr);
		boolean result = passwordEncoder.matches("1111", enStr);
		log.info(result);
			}
		}
	}

- MemberMapper.xml
<insert id="insert">
	insert into tbl_member (mid,mpw,mname,email)
	values ( #{mid},#{mpw},#{mname},#{email})
	</insert>
	
	<insert id="insertRoles">
	insert into tbl_member_role (mid,rolename)
	values
		<foreach collection="roleNames" separator="," item="roleName">
		(#{mid}, #{roleName} )
		</foreach>
	
	</insert>

- MemberMapper.java 생성
int insertRoles(MemberDTO memberDTO);



- MemberMapperTests
@Autowired(required=false)
private MemberMapper mapper;


@Test
public void testInsert() {
	
	//20명 user1 - user20, 1111
	// user1 - user9 까지는 'USER'
	// user10 - user 19 까지는 'USER','MANAGER'
	// user20 'USER','MANAGER','ADMIN'
	
	for(int i = 1; i <=20; i++) {
	
		MemberDTO dto = new MemberDTO();

		dto.setMid("user" +i);
		dto.setMpw(passwordEncoder.encode("1111"));
		dto.setMname("사용자"+i);
		dto.setEmail("user"+i+"@aaa.com");

		if(i < 10) {
			dto.setRoleNames(List.of("USER"));
		}else if(i < 20) {
			dto.setRoleNames(List.of("USER","MANAGER"));
		}else if(i < 20) {
			dto.setRoleNames(List.of("USER","MANAGER","ADMIN"));

		}
		mapper.insert(dto);
		mapper.insertRoles(dto);

	}
 
}


- interface
MemberDTO selectMymid (String mid);

- mapper.xml





- CustomUserDetails
private final MemberMapper memberMapper;

~~~~~~~~~~~~

MemberDTO memberDTO = memberMapper.selectByMid(username);

if(memberDTO == null) {
			throw new UsernameNotFoundException("MEMBER NOT EXIST");
		}

- MemberDTO
@Setter
@Getter
@ToString
public class MemberDTO implements UserDetails {

	private String mid;
	private String mpw;
	private String mname;
	private String email;
	
	private LocalDateTime regDate;
	private LocalDateTime modDate;

	private List<String> roleNames;

	@Override
	public Collection<? extends GrantedAuthority> getAuthorities() {
		return roleNames.stream()
				.map(roleStr -> new SimpleGrantedAuthority("ROLE_"+roleStr))
				.collect(Collectors.toList());
	}

	@Override
	public String getPassword() {
		return mpw;
	}

	@Override
	public String getUsername() {
		return mid;
	}
}


- CustomUserDetails
		if(memberDTO == null) {
			throw new UsernameNotFoundException("MEMBER NOT EXIST");
		}
		
		
		
		/*
		 * UserDetails user = User.builder() .username(username)
		 * .password("$2a$10$nQ12.AaWcuxvBwjn3Q0NY..BPTgonCpFOORqeUlMiALYhbd7laCUW")
		 * .authorities("ROLE_USER", "ROLE_MANAGER", "ROLE_USER") .build();
		 */  이거 삭제
		
		return memberDTO;


==========================================	

<sec:authentication property="principal" var="secInfo"/>





